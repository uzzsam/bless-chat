{
  "version": 3,
  "sources": ["../widget/src/index.ts"],
  "sourcesContent": ["/*\n  Bless chat widget: mounts into a container that has data-chat-container attribute.\n  Email collection integrated in chat flow before blessing reveal\n*/\n\ntype Role = 'user' | 'assistant';\n\ninterface Message {\n  role: Role;\n  content: string;\n}\n\ninterface WidgetOptions {\n  apiUrl?: string;\n  placeholder?: string;\n  sendAriaLabel?: string;\n  loadingText?: string;\n  requireBlessing?: boolean;\n}\n\ninterface StreamMeta {\n  state?: string;\n  sidthieKey?: string | null;\n  sidthieLabel?: string | null;\n  userName?: string | null;\n  marker?: string | null;\n  done?: boolean;\n  messageCount?: number;\n}\n\nconst DEFAULTS: Required<WidgetOptions> = {\n  apiUrl: 'https://bless-test-brown.vercel.app/api/chat',\n  placeholder: 'Talk to Sidthah',\n  sendAriaLabel: 'Send message',\n  loadingText: 'Listening...',\n  requireBlessing: true,\n};\n\nfunction sanitizeString(value?: string | null): string | undefined {\n  if (value === undefined || value === null) return undefined;\n  const trimmed = value.toString().trim();\n  if (!trimmed) return undefined;\n  const lower = trimmed.toLowerCase();\n  if (lower === 'undefined' || lower === 'null') return undefined;\n  return trimmed;\n}\n\nfunction parseBooleanDataset(value?: string | null): boolean | undefined {\n  if (value === undefined || value === null) return undefined;\n  const normalized = value.toString().trim().toLowerCase();\n  if (!normalized) return true;\n  if (['false', '0', 'no', 'off', 'disabled'].includes(normalized)) return false;\n  if (['true', '1', 'yes', 'on', 'enabled'].includes(normalized)) return true;\n  return undefined;\n}\n\n// Base styles for the chat widget\nconst STYLE_BLOCK = `\n:root {\n  --bless-green-900: 23, 95, 75;\n  --bless-green-500: 70, 136, 111;\n  --bless-gold-400: 227, 216, 154;\n  --bless-cream-100: 236, 227, 214;\n  --bless-chat-max-width: 820px;\n  --bless-chat-radius: 48px;\n}\n\n.bless-chat-shell {\n  width: 100%;\n  max-width: min(var(--bless-chat-max-width), 92vw);\n  margin: 0 auto;\n  display: flex;\n  flex-direction: column;\n  gap: 1.75rem;\n  font-family: 'Albert Sans', 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n  color: rgba(var(--bless-cream-100), 0.92);\n}\n\n.bless-chat-window {\n  position: relative;\n  display: flex;\n  flex-direction: column;\n  gap: 1.1rem;\n  padding: clamp(1.75rem, 3vw, 2.4rem) clamp(1.5rem, 3vw, 2.8rem);\n  border-radius: var(--bless-chat-radius);\n  background: transparent;\n  box-shadow: none;\n  backdrop-filter: blur(6px);\n  border: 1px solid rgba(255,255,255,0.18);\n  overflow: hidden;\n}\n\n.bless-chat-window::after {\n  content: '';\n  position: absolute;\n  inset: 12px;\n  border-radius: calc(var(--bless-chat-radius) - 12px);\n  border: 1px solid rgba(255,255,255,0.12);\n  pointer-events: none;\n  opacity: 0.6;\n}\n\n.bless-chat-messages {\n  display: flex;\n  flex-direction: column;\n  gap: 1.1rem;\n  max-height: min(70vh, 700px);\n  overflow-y: auto;\n  padding-right: 0.5rem;\n}\n\n.bless-chat-messages::-webkit-scrollbar {\n  width: 6px;\n}\n\n.bless-chat-messages::-webkit-scrollbar-thumb {\n  background: rgba(var(--bless-cream-100),0.35);\n  border-radius: 999px;\n}\n\n.bless-chat-bubble {\n  position: relative;\n  padding: 1.65rem clamp(1.6rem, 3.8vw, 2.6rem);\n  border-radius: 42px;\n  background: transparent;\n  border: 1px solid rgba(255,255,255,0.24);\n  box-shadow: none;\n  backdrop-filter: blur(4px);\n  color: rgba(var(--bless-cream-100), 0.96);\n  font-size: clamp(1.02rem, 1vw + 0.9rem, 1.2rem);\n  line-height: 1.6;\n  text-align: left;\n  white-space: pre-line;\n}\n\n.bless-chat-bubble--user {\n  align-self: flex-end;\n  background: transparent;\n  border: 1px solid rgba(255,255,255,0.28);\n  color: rgba(var(--bless-cream-100), 0.92);\n}\n\n.bless-chat-bubble--status {\n  text-align: center;\n  font-size: 0.95rem;\n  color: rgba(var(--bless-cream-100), 0.65);\n  background: transparent;\n  border: 1px solid rgba(255,255,255,0.16);\n}\n\n/* Streaming indicator - using dots only, no cursor square */\n.bless-chat-bubble--streaming {\n  position: relative;\n}\n\n.bless-chat-bubble--streaming::after {\n  content: '';\n  display: inline-block;\n  width: 8px;\n  height: 8px;\n  margin-left: 6px;\n  border-radius: 50%;\n  background: rgba(var(--bless-cream-100), 0.75);\n  animation: bless-streaming-pulse 900ms ease-in-out infinite;\n}\n\n@keyframes bless-streaming-pulse {\n  0%, 100% { opacity: 0.35; transform: scale(1); }\n  50% { opacity: 1; transform: scale(1.2); }\n}\n\n.bless-chat-input-row {\n  display: flex;\n  gap: 1rem;\n  align-items: center;\n}\n\n.bless-chat-input-wrapper {\n  flex: 1;\n  display: flex;\n  align-items: center;\n  border-radius: 999px;\n  border: 1px solid rgba(255,255,255,0.22);\n  background: transparent;\n  padding: 0.4rem 0.4rem 0.4rem 1.4rem;\n  box-shadow: none;\n}\n\n.bless-chat-input {\n  flex: 1;\n  border: none;\n  background: transparent;\n  color: rgba(var(--bless-cream-100), 0.92);\n  font-size: clamp(1.05rem, 2vw, 1.2rem);\n  line-height: 1.4;\n  padding: 0.75rem 0;\n  background-color: transparent !important;\n  box-shadow: none !important;\n}\n\n.bless-chat-input::placeholder {\n  color: rgba(var(--bless-cream-100), 0.45);\n  opacity: 1;\n}\n\n.bless-chat-input:focus {\n  outline: none;\n  background-color: transparent !important;\n  box-shadow: none !important;\n}\n\n.bless-chat-input:hover,\n.bless-chat-input:focus {\n  background-color: transparent !important;\n  box-shadow: none !important;\n}\n\n.bless-chat-send {\n  flex-shrink: 0;\n  width: 64px;\n  height: 64px;\n  border-radius: 999px;\n  border: none;\n  background: radial-gradient(circle at 30% 30%, rgba(var(--bless-gold-400),0.95), rgba(var(--bless-gold-400),0.82));\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  cursor: pointer;\n  transition: transform 180ms ease, box-shadow 180ms ease;\n  box-shadow: 0 12px 32px rgba(0,0,0,0.32);\n}\n\n.bless-chat-send[disabled] {\n  cursor: not-allowed;\n  opacity: 0.7;\n  transform: none;\n  box-shadow: none;\n}\n\n.bless-chat-send:hover:not([disabled]),\n.bless-chat-send:focus-visible:not([disabled]) {\n  transform: translateY(-2px);\n  box-shadow: 0 18px 40px rgba(0,0,0,0.4);\n}\n\n.bless-chat-send svg {\n  width: 36px;\n  height: 20px;\n}\n\n.bless-chat-error {\n  margin-top: 0.5rem;\n  font-size: 0.95rem;\n  color: rgba(255, 129, 100, 0.88);\n  text-align: center;\n}\n\n/* Retry button */\n.bless-chat-retry {\n  padding: 0.75rem 1.75rem;\n  border-radius: 999px;\n  border: none;\n  background: rgba(var(--bless-gold-400), 0.92);\n  color: rgb(var(--bless-green-900));\n  font-family: inherit;\n  font-weight: 600;\n  cursor: pointer;\n  margin: 1rem auto;\n  display: block;\n  transition: transform 180ms ease;\n}\n\n.bless-chat-retry:hover {\n  transform: translateY(-2px);\n}\n\n/* Sidthie option buttons */\n.bless-chat-options {\n  display: grid;\n  grid-template-columns: repeat(2, minmax(0, 1fr));\n  gap: 0.6rem 0.75rem;\n}\n\n.bless-chat-option {\n  display: block;\n  padding: 0.85rem clamp(1.2rem, 2.6vw, 1.9rem);\n  border-radius: 32px;\n  background: transparent;\n  border: 1px solid rgba(255,255,255,0.24);\n  color: rgba(var(--bless-cream-100), 0.96);\n  font-size: clamp(0.92rem, 0.7vw + 0.82rem, 1.05rem);\n  line-height: 1.45;\n  cursor: pointer;\n  text-align: center;\n  transition: background-color 160ms ease, color 160ms ease, border-color 160ms ease;\n}\n\n.bless-chat-option:hover,\n.bless-chat-option:focus {\n  background: rgba(255,255,255,0.1);\n  border-color: rgba(255,255,255,0.35);\n}\n\n.bless-chat-option:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n/* FIXED: Simplified loading indicator - only one style */\n.bless-chat-bubble--status.is-typing {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.bless-typing {\n  display: inline-flex;\n  gap: 0.35rem;\n}\n\n.bless-typing span {\n  width: 8px;\n  height: 8px;\n  border-radius: 50%;\n  background: rgba(var(--bless-cream-100), 0.75);\n  animation: bless-dot 900ms ease-in-out infinite alternate;\n}\n\n.bless-typing span:nth-child(2) {\n  animation-delay: 120ms;\n}\n\n.bless-typing span:nth-child(3) {\n  animation-delay: 240ms;\n}\n\n@keyframes bless-dot {\n  from {\n    opacity: 0.35;\n    transform: translateY(0);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(-3px);\n  }\n}\n\n@media (max-width: 640px) {\n  .bless-chat-shell {\n    gap: 1.25rem;\n  }\n\n  .bless-chat-window {\n    border-radius: 32px;\n    padding: 1.4rem 1.3rem;\n  }\n\n  .bless-chat-window::after {\n    inset: 8px;\n    border-radius: 26px;\n  }\n\n  .bless-chat-bubble {\n    border-radius: 30px;\n    padding: 1.3rem 1.2rem;\n  }\n\n  .bless-chat-input-wrapper {\n    padding-left: 1.1rem;\n  }\n\n  .bless-chat-send {\n    width: 56px;\n    height: 56px;\n  }\n\n  .bless-chat-options {\n    grid-template-columns: 1fr;\n  }\n}\n\n/* Email input bubble */\n.bless-chat-email-bubble {\n  padding: 1.2rem !important;\n}\n\n.bless-chat-email-form {\n  display: flex;\n  flex-direction: column;\n  gap: 0.5rem;\n}\n\n.bless-chat-email-wrapper {\n  display: flex;\n  gap: 0.5rem;\n  align-items: center;\n}\n\n.bless-chat-email-input {\n  flex: 1;\n  padding: 0.75rem 1rem;\n  border-radius: 18px;\n  border: 1px solid rgba(255,255,255,0.22);\n  background: rgba(255,255,255,0.15);\n  color: rgba(var(--bless-cream-100), 0.92);\n  font-size: 1rem;\n  font-family: inherit;\n}\n\n.bless-chat-email-input::placeholder {\n  color: rgba(var(--bless-cream-100), 0.45);\n}\n\n.bless-chat-email-input:focus {\n  outline: none;\n  border-color: rgba(var(--bless-gold-400), 0.6);\n  background: rgba(255,255,255,0.2);\n}\n\n.bless-chat-email-submit {\n  padding: 0.75rem 1.5rem;\n  border-radius: 999px;\n  border: none;\n  background: rgba(var(--bless-gold-400), 0.92);\n  color: rgb(var(--bless-green-900));\n  font-family: inherit;\n  font-weight: 600;\n  font-size: 0.95rem;\n  cursor: pointer;\n  transition: transform 180ms ease, background-color 180ms ease;\n  white-space: nowrap;\n}\n\n.bless-chat-email-submit:hover:not(:disabled) {\n  transform: translateY(-1px);\n  background: rgba(var(--bless-gold-400), 1);\n}\n\n.bless-chat-email-submit:disabled {\n  opacity: 0.7;\n  cursor: not-allowed;\n}\n\n.bless-chat-email-error {\n  font-size: 0.9rem;\n  color: rgba(255, 129, 100, 0.95);\n  padding: 0.25rem 0;\n}\n\n/* Preview bubble */\n.bless-chat-preview {\n  position: relative;\n}\n\n.bless-chat-preview--truncated::after {\n  content: '';\n  position: absolute;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  height: 40px;\n  background: linear-gradient(to bottom, transparent, rgba(var(--bless-cream-100), 0.1));\n  pointer-events: none;\n}\n\n.bless-chat-error-bubble {\n  background: rgba(255, 129, 100, 0.15);\n  border-color: rgba(255, 129, 100, 0.3);\n}\n\n@media (max-width: 640px) {\n  .bless-chat-email-wrapper {\n    flex-direction: column;\n    align-items: stretch;\n  }\n  \n  .bless-chat-email-submit {\n    width: 100%;\n  }\n}\n`;\n\nconst styleEl = document.createElement('style');\nstyleEl.textContent = STYLE_BLOCK;\ndocument.head.appendChild(styleEl);\n\ninterface SidthieMeta {\n  key: string;\n  label: string;\n  short: string;\n  description: string;\n}\n\n// Updated Sidthie metadata with new names\nconst SIDTHIE_META: Record<string, SidthieMeta> = {\n  NALAMERA: {\n    key: 'NALAMERA',\n    label: 'Inner Strength',\n    short: 'A steady courage that rises quietly from within.',\n    description:\n      'Nalamera steadies the breath and roots the heart; she carries the quiet strength that holds families together when storms arrive.',\n  },\n  LUMASARA: {\n    key: 'LUMASARA',\n    label: 'Happiness',\n    short: 'A soft, luminous joy that brightens the ordinary.',\n    description:\n      'Lumasara brightens every ordinary moment with the glow of celebration, inviting laughter to linger like sunlight through leaves.',\n  },\n  WELAMORA: {\n    key: 'WELAMORA',\n    label: 'Love',\n    short: 'A tender presence that listens and embraces.',\n    description:\n      'Welamora listens with the whole heart, weaving warmth and devotion so love can be felt in every touch and every word.',\n  },\n  NIRALUMA: {\n    key: 'NIRALUMA',\n    label: 'Bliss',\n    short: 'A calm clarity that sees the path with kindness.',\n    description:\n      'Niraluma pours lantern-light across the path ahead, offering gentle bliss and serene grace to every decision you make.',\n  },\n  OLANWELA: {\n    key: 'OLANWELA',\n    label: 'Health',\n    short: 'A quiet mending that restores balance and breath.',\n    description:\n      'Olanwela soothes weary hearts and tired bones, bathing the spirit in cool rivers of renewal and vital health.',\n  },\n  RAKAWELA: {\n    key: 'RAKAWELA',\n    label: 'Peace',\n    short: 'A gentle guard that shelters what is precious.',\n    description:\n      'Rakawela stands as a quiet guardian, wrapping loved ones in peaceful kindness and turning away every shadow that approaches.',\n  },\n  MORASARA: {\n    key: 'MORASARA',\n    label: 'Fortune',\n    short: 'A stillness that settles and softens the heart.',\n    description:\n      'Morasara settles like evening mist, inviting deep breaths, calm conversations, and the promise of good fortune wherever you stand.',\n  },\n};\n\nconst SIDTHIE_VALUES = Object.values(SIDTHIE_META);\n\nfunction findSidthieByKey(key?: string | null): SidthieMeta | null {\n  if (!key) return null;\n  const upper = key.toUpperCase();\n  return SIDTHIE_META[upper] ?? null;\n}\n\nfunction findSidthieByLabel(text?: string | null): SidthieMeta | null {\n  if (!text) return null;\n  const trimmed = text.trim().toLowerCase();\n  return (\n    SIDTHIE_VALUES.find((meta) => meta.label.toLowerCase() === trimmed) ??\n    SIDTHIE_VALUES.find((meta) => trimmed.includes(meta.label.toLowerCase())) ??\n    null\n  );\n}\n\nfunction svgArrow() {\n  return `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<svg viewBox=\"0 0 120 64\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n  <g stroke=\"#175F4B\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n    <path d=\"M14 32H94\" />\n    <path d=\"M70 14L94 32L70 50\" />\n    <circle cx=\"106\" cy=\"32\" r=\"4.5\" fill=\"#175F4B\" stroke=\"#175F4B\" stroke-width=\"2\" />\n  </g>\n</svg>`;\n}\n\nconst SESSION_KEY = 'bless-chat-blessing-created';\n\nconst CLEAN_PATTERNS: RegExp[] = [\n  /Thank you for (sharing|uploading|providing).*?(files?|documents?|that)!?.*$/gim,\n  /How can I assist you with (them|it|the files?)\\?.*$/gim,\n  /Would you like me to search for specific information.*$/gim,\n  /or summarize the content\\?.*$/gim,\n  /\\\u3010\\d+:\\d+\u2020source\\\u3011/g,\n  /To create a personalized blessing.*?providing the files?!?/gim,\n  /and for providing the files?!?/gim\n];\n\nfunction cleanAssistantText(message: string) {\n  let cleaned = message ?? '';\n  CLEAN_PATTERNS.forEach((pattern) => {\n    cleaned = cleaned.replace(pattern, '');\n  });\n  return cleaned.trim();\n}\n\nfunction getSessionFlag(key: string) {\n  try {\n    return typeof sessionStorage !== 'undefined' ? sessionStorage.getItem(key) : null;\n  } catch {\n    return null;\n  }\n}\n\nfunction setSessionFlag(key: string, value: string) {\n  try {\n    if (typeof sessionStorage !== 'undefined') {\n      sessionStorage.setItem(key, value);\n    }\n  } catch {\n    /* ignore storage errors */\n  }\n}\n\nfunction revealBlessing(blessing: string) {\n  const sel = [\n    '[data-bless-panel]',\n    '.bless-blessing__panel',\n    '#bless-blessing__panel'\n  ].join(',');\n\n  document.querySelectorAll<HTMLElement>(sel).forEach((el) => {\n    el.style.fontFamily = \"'Cormorant Upright', serif\";\n    el.style.whiteSpace = 'pre-line';\n    el.style.textAlign = 'center';\n    el.style.color = '#fff';\n    el.style.fontSize = 'clamp(18px, 2.4vw, 30px)';\n    el.style.lineHeight = '1.35';\n    el.style.textShadow = '0 2px 8px rgba(0,0,0,.55)';\n    el.textContent = blessing;\n  });\n}\n\nfunction parseSidthieOptions(payload: string | undefined | null) {\n  if (!payload) return null;\n  const processed = payload\n    .replace(/([*\\-\u2022]?\\s*)([1-7])[\\.\\)\\:]\\s*/g, '\\n$2. ')\n    .replace(/\\s{2,}/g, ' ')\n    .trim();\n  const lines = processed.split(/\\r?\\n/).map((l) => l.trim()).filter(Boolean);\n  const optionLines = lines.filter((line) => /^[1-7]\\.\\s*/.test(line));\n  if (optionLines.length < 7) return null;\n  const introLines = lines.filter((line) => !/^[1-7]\\.\\s*/.test(line));\n  const intro = introLines.join(' ').trim();\n  const hasAll = SIDTHIE_VALUES.every((meta) => {\n    const lower = processed.toLowerCase();\n    return lower.includes(meta.label.toLowerCase()) || processed.includes(`(${meta.key})`);\n  });\n  if (!hasAll) return null;\n  const options = SIDTHIE_VALUES.map((meta) => `${meta.label} (${meta.key})`);\n  return { intro, options, metas: SIDTHIE_VALUES };\n}\n\nfunction resolveSidthieFromOption(option: string): SidthieMeta | null {\n  if (!option) return null;\n  const keyMatch = option.match(/\\(([A-Za-z]+)\\)\\s*$/);\n  if (keyMatch) {\n    const meta = findSidthieByKey(keyMatch[1]);\n    if (meta) return meta;\n  }\n  const label = option.replace(/\\([^)]*\\)/g, '').trim();\n  return findSidthieByLabel(label);\n}\n\nclass BlessChatWidget {\n  private container: HTMLElement;\n  private options: Required<WidgetOptions>;\n  private messages: Message[] = [];\n  private isProcessing = false;\n  private blessingDelivered = false;\n\n  private messageList!: HTMLElement;\n  private inputEl!: HTMLInputElement;\n  private sendBtn!: HTMLButtonElement;\n  private statusEl!: HTMLElement;\n  private errorEl!: HTMLElement;\n  private currentStreamingNode: HTMLDivElement | null = null;\n  private currentStreamingText = '';\n  private activeSidthie: SidthieMeta | null = null;\n  private lastExplanation = '';\n  \n  // Email collection state\n  private pendingBlessing: string | null = null;\n  private pendingBlessingMeta: StreamMeta | null = null;\n  private collectedEmail: string | null = null;\n  private awaitingEmail = false;\n  private readonly N8N_WEBHOOK_URL = 'https://n8n.theexperiencen8n.top/webhook-test/951bd832-961c-4f19-a263-96632039cd07';\n  private readonly THANK_YOU_PAGE = '/pages/blessing-thank-you';\n  \n  // Daily limits\n  private blessingCount: number = 0;\n  private readonly MAX_BLESSINGS = 3;\n  private readonly STORAGE_KEY = 'bless-chat-session-count';\n\n  constructor(container: HTMLElement, options?: WidgetOptions) {\n    this.container = container;\n    const merged = { ...DEFAULTS, ...(options || {}) };\n    this.options = {\n      apiUrl: sanitizeString(merged.apiUrl) ?? DEFAULTS.apiUrl,\n      placeholder: sanitizeString(merged.placeholder) ?? DEFAULTS.placeholder,\n      sendAriaLabel: sanitizeString(merged.sendAriaLabel) ?? DEFAULTS.sendAriaLabel,\n      loadingText: sanitizeString(merged.loadingText) ?? DEFAULTS.loadingText,\n      requireBlessing: merged.requireBlessing\n    };\n    this.blessingDelivered = getSessionFlag(SESSION_KEY) === 'true';\n    this.blessingCount = this.getBlessingCount();\n    \n    if (!this.options.requireBlessing && this.blessingDelivered) {\n      this.blessingDelivered = false;\n    }\n  }\n  \n  // Blessing count helpers\n  private getBlessingCount(): number {\n    try {\n      const stored = sessionStorage.getItem(this.STORAGE_KEY);\n      return stored ? parseInt(stored, 10) : 0;\n    } catch {\n      return 0;\n    }\n  }\n\n  private incrementBlessingCount(): void {\n    this.blessingCount += 1;\n    try {\n      sessionStorage.setItem(this.STORAGE_KEY, this.blessingCount.toString());\n    } catch {\n      // Ignore storage errors\n    }\n  }\n\n  private hasReachedLimit(): boolean {\n    return this.blessingCount >= this.MAX_BLESSINGS;\n  }\n  \n  private showLimitReached() {\n    this.pushAssistantMessage(\n      `Three blessings daily allows each to settle deeply. You have received ${this.blessingCount} blessing${this.blessingCount > 1 ? 's' : ''} this session. Close your browser to begin a new session, or return tomorrow for fresh blessings.`\n    );\n    this.inputEl.disabled = true;\n    this.sendBtn.disabled = true;\n  }\n\n  mount() {\n    const widthAttr = sanitizeString(this.container.dataset.chatWidth);\n    if (widthAttr) {\n      this.container.style.setProperty('--bless-chat-max-width', widthAttr);\n    }\n    const radiusAttr = sanitizeString(this.container.dataset.chatRadius);\n    if (radiusAttr) {\n      this.container.style.setProperty('--bless-chat-radius', radiusAttr);\n    }\n\n    this.container.innerHTML = '';\n    this.container.classList.add('bless-chat-shell');\n\n    const windowEl = document.createElement('div');\n    windowEl.className = 'bless-chat-window';\n\n    this.messageList = document.createElement('div');\n    this.messageList.className = 'bless-chat-messages';\n\n    this.statusEl = document.createElement('div');\n    this.statusEl.className = 'bless-chat-bubble bless-chat-bubble--status';\n    this.statusEl.hidden = true;\n\n    this.errorEl = document.createElement('div');\n    this.errorEl.className = 'bless-chat-error';\n    this.errorEl.hidden = true;\n\n    const form = document.createElement('form');\n    form.className = 'bless-chat-input-row';\n\n    const wrapper = document.createElement('div');\n    wrapper.className = 'bless-chat-input-wrapper';\n\n    this.inputEl = document.createElement('input');\n    this.inputEl.type = 'text';\n    this.inputEl.className = 'bless-chat-input';\n    this.inputEl.placeholder = this.options.placeholder;\n    this.inputEl.autocomplete = 'off';\n    this.inputEl.spellcheck = false;\n    this.inputEl.setAttribute('aria-label', this.options.placeholder);\n\n    wrapper.appendChild(this.inputEl);\n\n    this.sendBtn = document.createElement('button');\n    this.sendBtn.type = 'submit';\n    this.sendBtn.className = 'bless-chat-send';\n    this.sendBtn.setAttribute('aria-label', this.options.sendAriaLabel);\n    this.sendBtn.innerHTML = svgArrow();\n\n    form.append(wrapper, this.sendBtn);\n\n    form.addEventListener('submit', (event) => {\n      event.preventDefault();\n      this.handleSubmit();\n    });\n\n    this.messageList.addEventListener('scroll', () => {\n      if (this.messageList.scrollTop === 0) {\n        this.messageList.classList.add('scrolled-top');\n      } else {\n        this.messageList.classList.remove('scrolled-top');\n      }\n    });\n\n    windowEl.append(this.messageList, this.statusEl, form, this.errorEl);\n    this.container.appendChild(windowEl);\n\n    this.inputEl.addEventListener('keydown', (event) => {\n      if (event.key === 'Enter' && !event.shiftKey) {\n        event.preventDefault();\n        this.handleSubmit();\n      }\n    });\n\n    // Check conditions before starting\n    if (this.blessingDelivered && this.options.requireBlessing) {\n      this.pushAssistantMessage('Your blessing has already been crafted. Scroll to revisit it below.');\n    } else if (this.hasReachedLimit()) {\n      this.showLimitReached();\n    } else {\n      if (!this.options.requireBlessing) {\n        setSessionFlag(SESSION_KEY, 'false');\n      }\n      this.startConversation();\n    }\n  }\n\n  private async startConversation() {\n    this.activeSidthie = null;\n    this.lastExplanation = '';\n    await this.fetchAssistantReply();\n  }\n\n  private async handleSubmit() {\n    if (this.isProcessing) return;\n\n    const value = this.inputEl.value.trim();\n    if (!value) {\n      this.inputEl.reportValidity();\n      return;\n    }\n\n    if (this.blessingDelivered && this.options.requireBlessing) {\n      this.pushAssistantMessage('Your blessing has been created. Scroll down to read it.');\n      this.inputEl.value = '';\n      return;\n    }\n\n    this.appendMessage({ role: 'user', content: value });\n    this.inputEl.value = '';\n    this.messages.push({ role: 'user', content: value });\n    await this.fetchAssistantReply();\n  }\n\n  private appendMessage(message: Message, isStreaming = false) {\n    if (message.role === 'assistant' && !isStreaming) {\n      this.captureExplanation(message.content);\n      const parsed = parseSidthieOptions(message.content);\n      if (parsed) {\n        this.messages.push({ role: 'assistant', content: message.content });\n        this.createOptionsBubble(parsed.options, parsed.intro, parsed.metas);\n        return;\n      }\n    }\n\n    const bubble = document.createElement('div');\n    bubble.className = 'bless-chat-bubble';\n    if (message.role === 'user') {\n      bubble.classList.add('bless-chat-bubble--user');\n    }\n\n    bubble.textContent = message.content;\n    this.messageList.appendChild(bubble);\n    this.scrollToBottom();\n\n    if (message.role === 'assistant' && isStreaming) {\n      bubble.classList.add('bless-chat-bubble--streaming');\n      this.currentStreamingNode = bubble;\n      this.currentStreamingText = message.content;\n    }\n  }\n\n  private captureExplanation(text?: string) {\n    if (!text) return;\n    const lines = text.split('\\n\\n');\n    if (lines.length > 0) {\n      const firstParagraph = lines[0].trim();\n      if (firstParagraph.length > 30 && firstParagraph.length < 300) {\n        this.lastExplanation = firstParagraph;\n      }\n    }\n  }\n\n  private createOptionsBubble(options: string[], intro: string, metas?: SidthieMeta[]) {\n    this.activeSidthie = null;\n\n    if (intro) {\n      const introBubble = document.createElement('div');\n      introBubble.className = 'bless-chat-bubble';\n      introBubble.textContent = intro;\n      this.messageList.appendChild(introBubble);\n      this.scrollToBottom();\n    }\n\n    const bubble = document.createElement('div');\n    bubble.className = 'bless-chat-bubble';\n    const container = document.createElement('div');\n    container.className = 'bless-chat-options';\n    \n    options.forEach((opt, index) => {\n      const btn = document.createElement('button');\n      btn.type = 'button';\n      btn.className = 'bless-chat-option';\n      btn.textContent = opt;\n      btn.addEventListener('click', () => {\n        const meta = metas?.[index] ?? resolveSidthieFromOption(opt);\n        if (meta) {\n          this.activeSidthie = meta;\n          try {\n            window.dispatchEvent(\n              new CustomEvent('sidthie:selected', {\n                detail: { sidthie: meta.key, sidthieLabel: meta.label },\n              })\n            );\n          } catch {\n            /* ignore dispatch errors */\n          }\n        }\n        this.appendMessage({ role: 'user', content: opt });\n        this.messages.push({ role: 'user', content: opt });\n        container.querySelectorAll('button').forEach((b) => {\n          (b as HTMLButtonElement).disabled = true;\n        });\n        this.fetchAssistantReply();\n      });\n      container.appendChild(btn);\n    });\n    \n    bubble.appendChild(container);\n    this.messageList.appendChild(bubble);\n    this.scrollToBottom();\n  }\n\n  private updateStreamingBubble(delta: string) {\n    if (!this.currentStreamingNode) return;\n    this.currentStreamingText += delta;\n    // True token streaming - display immediately as received\n    this.currentStreamingNode.textContent = this.currentStreamingText;\n    this.scrollToBottom();\n  }\n\n  private finalizeStreamingBubble(finalText: string) {\n    if (this.currentStreamingNode) {\n      this.currentStreamingNode.classList.remove('bless-chat-bubble--streaming');\n      \n      const parsed = parseSidthieOptions(finalText);\n      if (parsed) {\n        this.messageList.removeChild(this.currentStreamingNode);\n        this.currentStreamingNode = null;\n        this.currentStreamingText = '';\n        this.createOptionsBubble(parsed.options, parsed.intro);\n        return;\n      }\n      \n      this.currentStreamingNode.textContent = finalText.trim();\n    }\n    this.currentStreamingNode = null;\n    this.currentStreamingText = '';\n    this.scrollToBottom();\n  }\n\n  private pushAssistantMessage(text: string) {\n    const message = { role: 'assistant', content: text } as Message;\n    this.appendMessage(message);\n    this.messages.push(message);\n  }\n\n  private setStatus(text?: string, typing = false) {\n    if (text) {\n      if (typing) {\n        this.statusEl.innerHTML =\n          '<span class=\"bless-typing\" aria-hidden=\"true\"><span></span><span></span><span></span></span>';\n        this.statusEl.classList.add('is-typing');\n        this.statusEl.setAttribute('aria-label', text);\n      } else {\n        this.statusEl.textContent = text;\n        this.statusEl.classList.remove('is-typing');\n        this.statusEl.removeAttribute('aria-label');\n      }\n      this.statusEl.hidden = false;\n    } else {\n      this.statusEl.hidden = true;\n      this.statusEl.classList.remove('is-typing');\n      this.statusEl.innerHTML = '';\n      this.statusEl.removeAttribute('aria-label');\n    }\n  }\n\n  private setError(message?: string) {\n    if (message) {\n      this.errorEl.textContent = message;\n      this.errorEl.hidden = false;\n    } else {\n      this.errorEl.hidden = true;\n      this.errorEl.textContent = '';\n    }\n  }\n\n  private scrollToBottom() {\n    requestAnimationFrame(() => {\n      this.messageList.scrollTop = this.messageList.scrollHeight;\n    });\n  }\n  \n  // Retry button helper\n  private showRetryButton() {\n    const retryBtn = document.createElement('button');\n    retryBtn.type = 'button';\n    retryBtn.className = 'bless-chat-retry';\n    retryBtn.textContent = 'Try again';\n    retryBtn.addEventListener('click', () => {\n      retryBtn.remove();\n      this.fetchAssistantReply();\n    });\n    this.messageList.appendChild(retryBtn);\n    this.scrollToBottom();\n  }\n\n  private async fetchAssistantReply() {\n    this.isProcessing = true;\n    this.sendBtn.disabled = true;\n    this.setError();\n    this.setStatus(this.options.loadingText, true);\n\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout\n\n    try {\n      const response = await fetch(this.options.apiUrl, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ messages: this.messages }),\n        signal: controller.signal\n      });\n\n      clearTimeout(timeoutId);\n\n      if (!response.ok) {\n        const data = await safeJson(response);\n        throw new Error(data?.error || `Request failed with status ${response.status}`);\n      }\n\n      if (isStreamResponse(response)) {\n        await this.handleStream(response);\n      } else {\n        const data = await response.json();\n        const text = (data?.message as string) || '';\n        const done = Boolean(data?.done);\n        if (text) {\n          const cleaned = cleanAssistantText(text);\n          const payload = cleaned || text;\n          this.appendMessage({ role: 'assistant', content: payload });\n          this.messages.push({ role: 'assistant', content: payload });\n          this.onAssistantComplete(payload, done);\n          this.setStatus();\n        }\n      }\n    } catch (error: any) {\n      clearTimeout(timeoutId);\n      \n      console.error('Bless chat error', error);\n      \n      // User-friendly error messages\n      let errorMessage = 'Something went wrong. Please try again.';\n      if (error.name === 'AbortError') {\n        errorMessage = 'The response took too long. Let us try once more.';\n      } else if (error?.message) {\n        errorMessage = error.message;\n      }\n      \n      this.setError(errorMessage);\n      this.showRetryButton();\n    } finally {\n      this.setStatus();\n      this.isProcessing = false;\n      this.sendBtn.disabled = false;\n    }\n  }\n\n  private recordStateMarker(meta?: StreamMeta | null) {\n    if (!meta?.marker) return;\n    const marker = meta.marker.trim();\n    if (!marker) return;\n    this.messages.push({ role: 'assistant', content: marker });\n  }\n\n  private async handleStream(response: Response) {\n    const reader = response.body?.getReader();\n    if (!reader) {\n      const fallback = await response.text();\n      this.pushAssistantMessage(fallback);\n      return;\n    }\n\n    let doneFlag = false;\n    let aggregated = '';\n    let finalMeta: StreamMeta | null = null;\n\n    this.appendMessage({ role: 'assistant', content: '' }, true);\n\n    const decoder = new TextDecoder();\n    let buffer = '';\n\n    while (true) {\n      const { value, done } = await reader.read();\n      if (done) break;\n      buffer += decoder.decode(value, { stream: true });\n\n      const frames = buffer.split('\\n\\n');\n      buffer = frames.pop() || '';\n\n      for (const frame of frames) {\n        const lines = frame.split('\\n');\n        let data = '';\n\n        for (const line of lines) {\n          if (line.startsWith('data:')) {\n            data += line.slice(5).trim();\n          }\n        }\n\n        if (!data) continue;\n        if (data === '[DONE]') continue;\n\n        let payload: any;\n        try {\n          payload = JSON.parse(data);\n        } catch (error) {\n          console.warn('Unable to parse stream chunk', data);\n          continue;\n        }\n\n        if (payload.type === 'delta' && typeof payload.textDelta === 'string') {\n          aggregated += payload.textDelta;\n          this.updateStreamingBubble(payload.textDelta);\n        } else if (payload.type === 'done') {\n          finalMeta = payload.meta || null;\n          if (finalMeta && typeof finalMeta.done === 'boolean') {\n            doneFlag = finalMeta.done;\n          } else if (finalMeta?.state === 'compose_blessing') {\n            doneFlag = true;\n          }\n          if (!aggregated && typeof payload.text === 'string') {\n            aggregated = payload.text;\n          }\n        } else if (payload.type === 'meta') {\n          if (typeof payload.done === 'boolean') {\n            doneFlag = payload.done;\n          }\n          if (payload.marker) {\n            finalMeta = finalMeta ?? {};\n            if (!finalMeta.marker) {\n              finalMeta.marker = payload.marker;\n            }\n          }\n          if (!finalMeta) {\n            finalMeta = {\n              state: payload.state,\n              sidthieKey: payload.sidthieKey ?? null,\n              sidthieLabel: payload.sidthieLabel ?? null,\n              userName: payload.userName ?? null,\n              marker: payload.marker ?? null,\n              done: payload.done,\n            };\n          }\n        } else if (payload.type === 'error') {\n          throw new Error(payload.message || 'Unexpected error');\n        }\n      }\n    }\n\n    const resolved = aggregated.trim();\n    const cleaned = cleanAssistantText(resolved);\n    const output = cleaned || resolved;\n    this.finalizeStreamingBubble(output);\n    this.messages.push({ role: 'assistant', content: output });\n    this.recordStateMarker(finalMeta || undefined);\n    \n    this.onAssistantComplete(output, doneFlag, finalMeta || undefined);\n  }\n\n  private onAssistantComplete(\n    text: string, \n    done: boolean, \n    finalMeta?: StreamMeta\n  ) {\n    if (!text) return;\n\n    if (done) {\n      this.incrementBlessingCount();\n      \n      const prepared = this.prepareBlessing(text);\n      const blessing = prepared.blessing || prepared.raw || text.trim();\n      \n      // Store blessing for later use (after email collection)\n      this.pendingBlessing = blessing;\n      this.pendingBlessingMeta = finalMeta || null;\n\n      // Remove the full blessing from display\n      const last = this.messageList.lastElementChild;\n      if (last && last.classList.contains('bless-chat-bubble')) {\n        this.messageList.removeChild(last);\n      }\n\n      // Show preview and ask for email\n      this.showBlessingPreviewAndAskEmail(blessing, finalMeta);\n      \n      return;\n    }\n\n    if (/image|upload|photo|picture/i.test(text)) {\n      this.pushAssistantMessage('No image is needed. Let us continue in words.');\n    }\n  }\n\n  private extractBlessingPreview(blessing: string): string {\n    // Extract first 1-2 sentences, max ~150 chars\n    const sentences = blessing.split(/[.!?]+/).filter(s => s.trim().length > 0);\n    if (!sentences.length) return blessing.slice(0, 150);\n    \n    let preview = sentences[0].trim();\n    if (preview.length < 80 && sentences.length > 1) {\n      preview += '. ' + sentences[1].trim();\n    }\n    \n    // Limit to ~150 characters\n    if (preview.length > 150) {\n      preview = preview.slice(0, 147) + '...';\n    }\n    \n    return preview;\n  }\n\n  private showBlessingPreviewAndAskEmail(blessing: string, meta?: StreamMeta) {\n    // Extract and show preview\n    const preview = this.extractBlessingPreview(blessing);\n    const previewBubble = document.createElement('div');\n    previewBubble.className = 'bless-chat-bubble bless-chat-preview bless-chat-preview--truncated';\n    previewBubble.textContent = preview + '...';\n    this.messageList.appendChild(previewBubble);\n    this.scrollToBottom();\n    \n    // Ask for email\n    this.awaitingEmail = true;\n    this.inputEl.disabled = true;\n    this.sendBtn.disabled = true;\n    \n    setTimeout(() => {\n      this.pushAssistantMessage(\"What's your email so I can send you the complete blessing?\");\n      this.createEmailInputBubble();\n    }, 800);\n  }\n\n  private createEmailInputBubble() {\n    const bubble = document.createElement('div');\n    bubble.className = 'bless-chat-bubble bless-chat-email-bubble';\n    \n    const form = document.createElement('form');\n    form.className = 'bless-chat-email-form';\n    \n    const inputWrapper = document.createElement('div');\n    inputWrapper.className = 'bless-chat-email-wrapper';\n    \n    const emailInput = document.createElement('input');\n    emailInput.type = 'email';\n    emailInput.className = 'bless-chat-email-input';\n    emailInput.placeholder = 'Enter your email';\n    emailInput.required = true;\n    emailInput.autocomplete = 'email';\n    \n    const submitBtn = document.createElement('button');\n    submitBtn.type = 'submit';\n    submitBtn.className = 'bless-chat-email-submit';\n    submitBtn.textContent = 'Receive blessing';\n    \n    const errorMsg = document.createElement('div');\n    errorMsg.className = 'bless-chat-email-error';\n    errorMsg.hidden = true;\n    \n    inputWrapper.appendChild(emailInput);\n    inputWrapper.appendChild(submitBtn);\n    form.appendChild(inputWrapper);\n    form.appendChild(errorMsg);\n    bubble.appendChild(form);\n    \n    form.addEventListener('submit', async (e) => {\n      e.preventDefault();\n      const email = emailInput.value.trim();\n      \n      if (!this.validateEmail(email)) {\n        errorMsg.textContent = 'Please enter a valid email address';\n        errorMsg.hidden = false;\n        emailInput.focus();\n        return;\n      }\n      \n      errorMsg.hidden = true;\n      emailInput.disabled = true;\n      submitBtn.disabled = true;\n      submitBtn.textContent = 'Saving...';\n      \n      await this.handleEmailSubmission(email);\n    });\n    \n    this.messageList.appendChild(bubble);\n    this.scrollToBottom();\n    emailInput.focus();\n  }\n\n  private validateEmail(email: string): boolean {\n    return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email);\n  }\n\n  private async handleEmailSubmission(email: string) {\n    if (!this.pendingBlessing) {\n      this.pushAssistantMessage('Something went wrong. Please refresh and try again.');\n      return;\n    }\n    \n    try {\n      // Send to N8N\n      const success = await this.sendToN8N(email, this.pendingBlessing, this.pendingBlessingMeta || undefined);\n      \n      if (!success) {\n        throw new Error('Webhook failed');\n      }\n      \n      // Store email\n      this.collectedEmail = email;\n      this.blessingDelivered = true;\n      setSessionFlag(SESSION_KEY, 'true');\n      \n      // Display full blessing\n      this.displayBlessing(this.pendingBlessing, this.pendingBlessingMeta || undefined);\n      \n      // Show success message\n      this.pushAssistantMessage('Perfect! Your blessing has been sent to ' + email);\n      \n      // Redirect to thank you page\n      const userName = this.pendingBlessingMeta?.userName || null;\n      const sidthieKey = this.pendingBlessingMeta?.sidthieKey || null;\n      this.redirectToThankYou(userName || undefined, sidthieKey || undefined);\n      \n    } catch (error) {\n      console.error('Email submission error:', error);\n      \n      // Show error and retry option\n      const errorBubble = document.createElement('div');\n      errorBubble.className = 'bless-chat-bubble bless-chat-error-bubble';\n      errorBubble.textContent = \"We couldn't save your blessing right now. \";\n      \n      const retryBtn = document.createElement('button');\n      retryBtn.type = 'button';\n      retryBtn.className = 'bless-chat-retry';\n      retryBtn.textContent = 'Try again';\n      retryBtn.addEventListener('click', () => {\n        errorBubble.remove();\n        this.createEmailInputBubble();\n      });\n      \n      errorBubble.appendChild(retryBtn);\n      this.messageList.appendChild(errorBubble);\n      this.scrollToBottom();\n    }\n  }\n\n  private async sendToN8N(email: string, blessing: string, meta?: StreamMeta): Promise<boolean> {\n    const payload = {\n      email,\n      userName: meta?.userName || null,\n      blessedPersonName: meta?.userName || null,\n      chosenSidthie: meta?.sidthieKey || null,\n      sidthieLabel: meta?.sidthieLabel || null,\n      blessingText: blessing,\n      explanation: this.lastExplanation || null,\n      timestamp: new Date().toISOString()\n    };\n    \n    try {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout\n      \n      const response = await fetch(this.N8N_WEBHOOK_URL, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(payload),\n        signal: controller.signal\n      });\n      \n      clearTimeout(timeoutId);\n      \n      if (!response.ok) {\n        console.error('N8N webhook failed:', response.status, response.statusText);\n        return false;\n      }\n      \n      return true;\n    } catch (error: any) {\n      if (error.name === 'AbortError') {\n        console.error('N8N webhook timeout');\n      } else {\n        console.error('N8N webhook error:', error);\n      }\n      return false;\n    }\n  }\n\n  private redirectToThankYou(userName?: string, sidthieKey?: string) {\n    // Store blessing in sessionStorage\n    if (this.pendingBlessing) {\n      try {\n        sessionStorage.setItem('bless-blessing-text', this.pendingBlessing);\n        if (sidthieKey) {\n          sessionStorage.setItem('bless-sidthie-key', sidthieKey);\n        }\n      } catch {\n        // Ignore storage errors\n      }\n    }\n    \n    // Build URL\n    const params = new URLSearchParams();\n    if (userName) params.append('name', userName);\n    if (sidthieKey) params.append('sidthie', sidthieKey);\n    \n    const url = `${this.THANK_YOU_PAGE}${params.toString() ? '?' + params.toString() : ''}`;\n    \n    // Redirect after short delay\n    setTimeout(() => {\n      window.location.href = url;\n    }, 2000);\n  }\n\n  private prepareBlessing(raw: string) {\n    const cleaned = cleanAssistantText(raw);\n    const lines = cleaned\n      .split(/\\r?\\n/)\n      .map((line) => line.trim())\n      .filter(Boolean);\n\n    const poem: string[] = [];\n    const extra: string[] = [];\n    for (const line of lines) {\n      if (poem.length < 5 && !/^is the blessing/i.test(line)) {\n        poem.push(line);\n      } else if (!/^is the blessing/i.test(line)) {\n        extra.push(line);\n      }\n    }\n\n    return {\n      blessing: poem.join('\\n'),\n      extra,\n      raw: cleaned,\n    };\n  }\n\n  private displayBlessing(\n    blessing: string, \n    finalMeta?: StreamMeta\n  ) {\n    let meta = this.activeSidthie;\n    if (!meta && finalMeta?.sidthieKey) {\n      meta = findSidthieByKey(finalMeta.sidthieKey);\n      if (meta) this.activeSidthie = meta;\n    }\n    if (!meta && finalMeta?.sidthieLabel) {\n      meta = findSidthieByLabel(finalMeta.sidthieLabel);\n      if (meta) this.activeSidthie = meta;\n    }\n\n    const explanation = this.lastExplanation || meta?.description || meta?.short || '';\n\n    try {\n      revealBlessing(blessing);\n    } catch {\n      /* ignore reveal errors */\n    }\n\n    const detail = {\n      text: blessing,\n      blessing,\n      sidthie: meta?.key || null,\n      sidthieLabel: meta?.label || null,\n      explanation,\n      emailCollected: true,\n    };\n\n    this.renderBlessingPanel({ blessing, explanation, sidthieLabel: detail.sidthieLabel ?? undefined });\n    \n    if (meta) {\n      try {\n        window.dispatchEvent(\n          new CustomEvent('sidthie:selected', {\n            detail: { sidthie: meta.key, sidthieLabel: meta.label },\n          })\n        );\n      } catch {\n        /* ignore dispatch errors */\n      }\n    }\n    \n    window.dispatchEvent(new CustomEvent('blessing:ready', { detail }));\n    window.dispatchEvent(new CustomEvent('blessing:update', { detail }));\n    \n    // Auto-scroll to reveal blessing panel\n    setTimeout(() => {\n      this.scrollToBottom();\n      // Also try to scroll the main page to the blessing section\n      const blessingPanel = document.querySelector('[data-bless-panel], .bless-blessing__panel, #bless-blessing__panel');\n      if (blessingPanel) {\n        blessingPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });\n      }\n    }, 300);\n  }\n\n  private renderBlessingPanel(detail: {\n    blessing: string;\n    explanation?: string;\n    sidthieLabel?: string;\n  }) {\n    const sel = [\n      '[data-bless-panel]',\n      '.bless-blessing__panel',\n      '#bless-blessing__panel'\n    ].join(',');\n\n    document.querySelectorAll<HTMLElement>(sel).forEach((panel) => {\n      panel.style.fontFamily = \"'Cormorant Upright', serif\";\n      panel.style.whiteSpace = 'pre-line';\n      panel.style.textAlign = 'center';\n      panel.style.color = '#fff';\n      panel.style.fontSize = 'clamp(18px, 2.4vw, 30px)';\n      panel.style.lineHeight = '1.35';\n      panel.style.textShadow = '0 2px 8px rgba(0,0,0,.55)';\n\n      const content = panel.querySelector<HTMLElement>('[data-blessing-output]') || panel;\n      content.textContent = detail.blessing;\n      content.removeAttribute('hidden');\n\n      const meta = panel.querySelector<HTMLElement>('[data-blessing-meta]');\n      const metaTitle = panel.querySelector<HTMLElement>('[data-sidthie-title]');\n      const metaText = panel.querySelector<HTMLElement>('[data-sidthie-excerpt]');\n\n      if (meta) {\n        const hasLabel = Boolean(detail.sidthieLabel);\n        const hasExplanation = Boolean(detail.explanation);\n\n        if (metaTitle) {\n          if (hasLabel) {\n            metaTitle.textContent = detail.sidthieLabel!;\n            metaTitle.removeAttribute('hidden');\n          } else {\n            metaTitle.setAttribute('hidden', 'hidden');\n          }\n        }\n\n        if (metaText) {\n          if (hasExplanation) {\n            metaText.textContent = detail.explanation!;\n            metaText.removeAttribute('hidden');\n          } else {\n            metaText.setAttribute('hidden', 'hidden');\n          }\n        }\n\n        if (hasLabel || hasExplanation) {\n          meta.removeAttribute('hidden');\n        } else {\n          meta.setAttribute('hidden', 'hidden');\n        }\n      }\n\n      const signup = panel.querySelector<HTMLElement>('[data-blessing-signup]');\n      const signupPrompt = panel.querySelector<HTMLElement>('[data-signup-prompt]');\n      const signupInput = panel.querySelector<HTMLInputElement>('[data-signup-sidthie]');\n      const defaultPrompt = signupPrompt?.getAttribute('data-default-prompt') || signupPrompt?.textContent || '';\n\n      if (signup) {\n        if (signupPrompt) {\n          if (defaultPrompt.includes('{sidthie}')) {\n            signupPrompt.textContent = defaultPrompt.replace('{sidthie}', detail.sidthieLabel || 'your Sidthie');\n          } else if (detail.sidthieLabel) {\n            signupPrompt.textContent = `${defaultPrompt} (${detail.sidthieLabel})`;\n          }\n        }\n        if (signupInput) {\n        signupInput.value = detail.sidthieLabel || '';\n        }\n        // Ensure signup is visible\n          signup.removeAttribute('hidden');\n            signup.style.display = '';\n    }\n    \n    // Dispatch update event to sync with Shopify section\n    setTimeout(() => {\n      window.dispatchEvent(new CustomEvent('blessing:sync', { detail: { blessing: detail.blessing, sidthieLabel: detail.sidthieLabel, explanation: detail.explanation } }));\n    }, 100);\n  });\n}\n}\n\nfunction safeJson(response: Response) {\n  return response\n    .clone()\n    .json()\n    .catch(() => ({}));\n}\n\nfunction isStreamResponse(response: Response) {\n  const contentType = response.headers.get('Content-Type') || response.headers.get('content-type');\n  return contentType ? /ndjson|stream/.test(contentType) : false;\n}\n\nfunction resolveContainerConfig(element: HTMLElement): WidgetOptions {\n  const config: WidgetOptions = {};\n  const api = sanitizeString(element.dataset.apiUrl);\n  if (api) config.apiUrl = api;\n  const placeholder = sanitizeString(element.dataset.placeholder);\n  if (placeholder) config.placeholder = placeholder;\n  const loading = sanitizeString(element.dataset.loadingText);\n  if (loading) config.loadingText = loading;\n  const requireBlessing = parseBooleanDataset(element.dataset.requireBlessing);\n  if (typeof requireBlessing === 'boolean') config.requireBlessing = requireBlessing;\n  return config;\n}\n\nfunction mount(selector?: string, options?: WidgetOptions) {\n  const target = selector\n    ? document.querySelector<HTMLElement>(selector)\n    : document.querySelector<HTMLElement>('[data-chat-container]');\n\n  if (!target) {\n    console.warn('BlessChat: target container not found.');\n    return;\n  }\n\n  console.info('BlessChat: mounting widget', { selector, target });\n\n  const config = { ...resolveContainerConfig(target), ...(options || {}) };\n  const widget = new BlessChatWidget(target, config);\n  widget.mount();\n}\n\nif (typeof window !== 'undefined') {\n  (window as any).BlessChat = {\n    mount\n  };\n\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => mount());\n  } else {\n    setTimeout(() => mount(), 0);\n  }\n}\n\nexport { mount };\n"],
  "mappings": "6bAAA,IAAAA,GAAA,GAAAC,EAAAD,GAAA,WAAAE,IA8BA,IAAMC,EAAoC,CACxC,OAAQ,+CACR,YAAa,kBACb,cAAe,eACf,YAAa,eACb,gBAAiB,EACnB,EAEA,SAASC,EAAeC,EAA2C,CACjE,GAA2BA,GAAU,KAAM,OAC3C,IAAMC,EAAUD,EAAM,SAAS,EAAE,KAAK,EACtC,GAAI,CAACC,EAAS,OACd,IAAMC,EAAQD,EAAQ,YAAY,EAClC,GAAI,EAAAC,IAAU,aAAeA,IAAU,QACvC,OAAOD,CACT,CAEA,SAASE,EAAoBH,EAA4C,CACvE,GAA2BA,GAAU,KAAM,OAC3C,IAAMI,EAAaJ,EAAM,SAAS,EAAE,KAAK,EAAE,YAAY,EACvD,GAAI,CAACI,EAAY,MAAO,GACxB,GAAI,CAAC,QAAS,IAAK,KAAM,MAAO,UAAU,EAAE,SAASA,CAAU,EAAG,MAAO,GACzE,GAAI,CAAC,OAAQ,IAAK,MAAO,KAAM,SAAS,EAAE,SAASA,CAAU,EAAG,MAAO,EAEzE,CAGA,IAAMC,EAAc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;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",
  "names": ["src_exports", "__export", "mount", "DEFAULTS", "sanitizeString", "value", "trimmed", "lower", "parseBooleanDataset", "normalized", "STYLE_BLOCK", "styleEl", "SIDTHIE_META", "SIDTHIE_VALUES", "findSidthieByKey", "key", "_a", "upper", "findSidthieByLabel", "text", "_b", "meta", "svgArrow", "SESSION_KEY", "CLEAN_PATTERNS", "cleanAssistantText", "message", "cleaned", "pattern", "getSessionFlag", "setSessionFlag", "revealBlessing", "blessing", "sel", "el", "parseSidthieOptions", "payload", "processed", "lines", "l", "line", "intro", "options", "resolveSidthieFromOption", "option", "keyMatch", "label", "BlessChatWidget", "container", "_c", "_d", "merged", "stored", "widthAttr", "radiusAttr", "windowEl", "form", "wrapper", "event", "isStreaming", "parsed", "bubble", "firstParagraph", "metas", "introBubble", "opt", "index", "btn", "b", "delta", "finalText", "typing", "retryBtn", "controller", "timeoutId", "response", "data", "safeJson", "isStreamResponse", "done", "error", "errorMessage", "marker", "_e", "reader", "fallback", "doneFlag", "aggregated", "finalMeta", "decoder", "buffer", "frames", "frame", "resolved", "output", "prepared", "last", "sentences", "s", "preview", "previewBubble", "inputWrapper", "emailInput", "submitBtn", "errorMsg", "e", "email", "userName", "sidthieKey", "errorBubble", "params", "url", "raw", "poem", "extra", "explanation", "detail", "blessingPanel", "panel", "content", "metaTitle", "metaText", "hasLabel", "hasExplanation", "signup", "signupPrompt", "signupInput", "defaultPrompt", "contentType", "resolveContainerConfig", "element", "config", "api", "placeholder", "loading", "requireBlessing", "selector", "target"]
}
